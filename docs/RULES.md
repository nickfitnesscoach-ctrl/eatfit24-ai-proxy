# RULES: EatFit24 AI Proxy

Микросервис-прокси для вызова AI (OpenRouter) из EatFit24.
Задача сервиса: принять `image_url` + опциональный `user_comment`, сходить в AI-модель и вернуть структурированный КБЖУ-ответ.

---

## 1. Общие принципы

1. Сервис **не хранит персональные данные**.
2. Сервис **без БД**. Всё состояние — только в памяти на время запроса.
3. API **строго типизирован** через Pydantic-схемы в `app/schemas.py`.
4. Любое изменение контракта API фиксируем в:
   - `app/schemas.py`
   - `README.md` (раздел с описанием эндпоинта)
5. Весь текст и код — **UTF-8**, переводы строк — `LF`.

---

## 2. Технологический стек

- Python 3.12+
- FastAPI
- Uvicorn
- httpx
- python-dotenv (для загрузки `.env` локально)
- Docker + `docker compose`

Файл зависимостей: `requirements.txt`.
Никаких лишних пакетов без необходимости.

---

## 3. Структура репозитория

```text
app/
  __init__.py
  main.py              # вход FastAPI, маршруты
  schemas.py           # Pydantic-модели запросов/ответов
  openrouter_client.py # логика общения с OpenRouter (AI)
  config.py            # чтение env-переменных, базовые настройки (TODO)

docs/                  # доп. документация (если нужно)
README.md              # описание проекта
ROADMAP.md             # этапы развития и текущий статус
RULES.md               # этот файл
requirements.txt
Dockerfile
docker-compose.yml
.env.example
.gitignore
```

Если появляется новый модуль — он должен логически вписываться в эту структуру. Хаотичных файлов в корне не добавляем.

---

## 4. Python-код: стиль и требования

- Стиль — **PEP8**, имена понятные, без сокращений в духе `a`, `b`, `x1`.
- **Обязательны аннотации типов** (`def func(x: int) -> str:`).
- Один модуль — одна зона ответственности:
  - `main.py` — роуты, DI, wiring.
  - `schemas.py` — структуры данных.
  - `openrouter_client.py` — работа с внешним AI.
- Исключения:
  - не бросаем сырые `Exception`,
  - для ошибок внешнего сервиса — свои исключения, которые маппятся на HTTP-ответы в `main.py`.
- В коде не должно быть русско-английской мешанины:
  - идентификаторы и код — по-английски,
  - комментарии и доки — можно по-русски, но лучше коротко.

---

## 5. Работа с зависимостями

Ставим пакеты через `pip install ...`, после чего обновляем `requirements.txt`:

```bash
pip freeze > requirements.txt
```

- Не добавляем тяжёлые фреймворки и БД-клиентов без необходимости.
- Если пакет больше не используется — удаляем импорт и пересобираем `requirements.txt`.

---

## 6. Переменные окружения и секреты

- Все переменные описаны в `.env.example`.
- Реальный `.env`:
  - не коммитится,
  - хранится локально и на сервере.
- **Обязательные переменные**:
  - `OPENROUTER_API_KEY` — ключ к AI.
  - `API_PROXY_SECRET` — секрет для авторизации запросов от RU-бэкенда.
- Чтение env — через единый модуль `config.py` (TODO):
  - там же можно задавать дефолты и валидацию.

---

## 7. API-правила

- Базовый префикс: `/api/v1/`.
- Основной эндпоинт:
  - `POST /api/v1/ai/recognize-food`
  - тело запроса и ответ — строго по `schemas.py`.
- `user_comment` всегда опционален:
  - на всех уровнях (схемы, логика, промпт).
- **Обратная совместимость**:
  - по возможности не ломаем существующие поля,
  - если нужен breaking change — сначала добавляем новое поле/поведение, потом deprecated-метки.

---

## 8. Ошибки и логирование

- Внешним клиентам (Django) отдаём аккуратные HTTP-ответы:
  - `200` — успех,
  - `400` — некорректный запрос,
  - `401/403` — проблемы с секретом/доступом,
  - `500` — внутренняя ошибка или проблема с AI-провайдером.
- В логах **не пишем**:
  - тело запросов,
  - полные ответы внешних сервисов.
- **Логируем**:
  - статус вызова OpenRouter,
  - код ошибки,
  - время ответа.
- Для прод-окружения уровень логирования — не более `INFO`, без дебажного мусора.

---

## 9. Docker и запуск

### Локально (без Docker)
```bash
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
uvicorn app.main:app --reload --port 8001
```

### Через Docker
```bash
docker compose up --build
```

Сервис по умолчанию слушает `0.0.0.0:8001`.

---

## 10. Git и коммиты

- Один коммит — один логический шаг:
  - `Add OpenRouter client and wire /recognize-food`
  - `Implement API key auth for incoming requests`
- **Не коммитим**:
  - `.env`,
  - `venv/`,
  - локальные файловые артефакты.
- Перед пушем:
  - `git status` — всё чисто, только нужные файлы,
  - по возможности — локальный запуск `uvicorn` или `docker compose up` для проверки.

---

## 11. Порядок изменений (flow)

Когда нужно добавить новую фичу / изменить поведение:

1. Обновить `ROADMAP.md` — какой именно шаг выполняем.
2. Изменить/добавить схемы (`schemas.py`), если трогаем API.
3. Реализовать логику (в нужном модуле).
4. Проверить локально через:
   - `curl` / Postman,
   - или временные unit-тесты (по желанию).
5. Обновить документацию:
   - `README.md` — если меняется внешний API.
6. Сделать коммит с понятным сообщением и запушить.
